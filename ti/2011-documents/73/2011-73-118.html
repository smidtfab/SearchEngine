



<div id="infoLinks" style="margin-left:450px;">
    <a href="/ReCaptcha+Plugin?xhr=true&update=contentPane" onclick="YAHOO.util.Connect.asyncRequest('POST', '/ReCaptcha+Plugin', {success: function(o){YAHOO.util.Dom.get('contentPane').innerHTML = o.responseText;}, failure: function(o){}}, 'xhr=true&update=contentPane');return false;"><img src="/images/icon-edit.png" width="15" height="15" alt="Icon Edit" class="inlineIcon" border="0" /></a>
    <a href="/ReCaptcha+Plugin?xhr=true&update=contentPane" onclick="YAHOO.util.Connect.asyncRequest('POST', '/ReCaptcha+Plugin', {success: function(o){YAHOO.util.Dom.get('contentPane').innerHTML = o.responseText;}, failure: function(o){}}, 'xhr=true&update=contentPane');return false;">View Page</a>

    

</div>


<h3>Page: ReCaptcha Plugin, Version:8</h3>

<div id="editPane">
    <a name="Introduction"></a><h1>Introduction</h1><p class="paragraph"/>This plugin is designed to make using the ReCaptcha and Mailhide services within Grails easy. In order to use this plugin, you must have a ReCaptcha account, available from <a href="http://recaptcha.net" class="pageLink">http://recaptcha.net</a>.<p class="paragraph"/><a name="Installation"></a><h1>Installation</h1><p class="paragraph"/>This plugin is easily installed from the Grails plugin repository.<p class="paragraph"/>Issue this command to install:
 <code>grails install-plugin recaptcha</code> .<p class="paragraph"/><a name="Usage - ReCaptcha"></a><h1>Usage - ReCaptcha</h1><p class="paragraph"/>The plugin is simple to use. In order to use it, there are four basic steps:<p class="paragraph"/><a name="Edit the Configuration"></a><h2>Edit the Configuration</h2><p class="paragraph"/>The plugin creates a file called  <code>RecaptchaConfig.groovy</code>  in  <code>grails-app/conf</code>  that has the following content:
<div class="code"><pre>recaptcha &#123;
    // These keys are generated by the ReCaptcha service
     publicKey = <span class="java&#45;quote">""</span>
     privateKey = <span class="java&#45;quote">""</span><p class="paragraph"/>   // Include the noscript tags in the generated captcha
     includeNoScript = <span class="java&#45;keyword">true</span>
&#125;<p class="paragraph"/>mailhide &#123;
    publicKey = <span class="java&#45;quote">""</span>
    privateKey = <span class="java&#45;quote">""</span>
&#125;<p class="paragraph"/>environments &#123;
  development &#123;
    recaptcha &#123;
      // Set to <span class="java&#45;keyword">false</span> to disable the display of captcha
      enabled = <span class="java&#45;keyword">false</span><p class="paragraph"/>      // Communicate using HTTPS
      useSecureAPI = <span class="java&#45;keyword">false</span>
    &#125;
  &#125;
  production &#123;
    recaptcha &#123;
      // Set to <span class="java&#45;keyword">false</span> to disable the display of captcha
      enabled = <span class="java&#45;keyword">true</span><p class="paragraph"/>      // Communicate using HTTPS
      useSecureAPI = <span class="java&#45;keyword">true</span>
    &#125;
  &#125;
&#125;</pre></div>
The values are pretty self-explanatory, and match with values used by the ReCaptcha service. You must enter your public and private ReCaptcha keys, or errors will be thrown when trying to display a captcha. Note that you can override values within the  <code>environments</code>  closure.<p class="paragraph"/><a name="Use the Tag Library"></a><h2>Use the Tag Library</h2><p class="paragraph"/>The plugin includes four ReCaptcha tags:  <code>&#60;recaptcha:ifEnabled&#62;</code> , <code>&#60;recaptcha:ifDisabled&#62;@, @&#60;recaptcha:recaptcha&#62;</code> , and  <code>&#60;recaptcha:ifFailed&#62;</code> .
<ul class="star">
<li>The  <code>&#60;recaptcha:ifEnabled&#62;</code>  tag is a simple utility tag that will render the contents of the tag if the captcha is enabled in  <code>RecaptchaConfig.groovy</code> .</li>
<li>The  <code>&#60;recaptcha:ifDisabled&#62;</code>  tag is a simple utility tag that will render the contents of the tag if the captcha is disabled in  <code>RecaptchaConfig.groovy</code> .</li>
<li>The  <code>&#60;recaptcha:recaptcha&#62;</code>  tag is responsible for generating the correct HTML output to display the captcha. It supports four attributes: "theme", "lang", "tabindex", and "custom_theme_widget". These attributes map directly to the values that can be set according to the ReCaptcha API. See the <a href="http://recaptcha.net/apidocs/captcha/client.html" class="pageLink">ReCaptcha Client Guide</a> for more details.</li>
<li>The  <code>&#60;recaptcha:ifFailed&#62;</code>  tag will render its contents if the previous validation failed. Some ReCaptcha themes, like "clean", do not display error messages and require the developer to show an error message. Use this tag if you're using one of these themes.</li>
</ul><a name="Verify the Captcha"></a><h2>Verify the Captcha</h2><p class="paragraph"/>In your controller, call  <code>recaptchaService.verifyAnswer(session, request.getRemoteAddr(), params)</code>  to verify the answer provided by the user. This method will return true or false, but will set the  <code>error_message</code>  property on the captcha behind the scenes so that the error message will be properly displayed when the ReCaptcha is redisplayed. Also note that  <code>verifyAnswer</code>  will return  <code>true</code>  if the plugin has been disabled in the configuration - this means you won't have to change your controller.<p class="paragraph"/><a name="Clean up After Yourself"></a><h2>Clean up After Yourself</h2><p class="paragraph"/>Once the captcha has been verified, call  <code>recaptchaService.cleanUp(session)</code> . This is not strictly needed, but it will clean the errors from the session.<p class="paragraph"/><a name="Examples"></a><h2>Examples</h2><p class="paragraph"/>Here's a simple example pulled from an account creation application.<p class="paragraph"/><a name="Tag Usage"></a><h3>Tag Usage</h3><p class="paragraph"/>In  <code>create.gsp</code> , we add the code to show the captcha:
<div class="code"><pre>&#60;recaptcha:ifEnabled&#62;
    &#60;recaptcha:recaptcha theme=<span class="java&#45;quote">"blackglass"</span>/&#62;
&#60;/recaptcha:ifEnabled&#62;</pre></div>
In this example, we're using ReCaptcha's "blackglass" theme. Leaving out the "theme" attribute will default the captcha to the "red" theme.<p class="paragraph"/>If you are using a theme that does not supply error messages, your code might look like this:
<div class="code"><pre>&#60;recaptcha:ifEnabled&#62;
    &#60;recaptcha:recaptcha theme=<span class="java&#45;quote">"clean"</span>/&#62;
    &#60;recaptcha:ifFailed&#62;CAPTCHA Failed&#60;/recaptcha:ifFailed&#62;
&#60;/recaptcha:ifEnabled&#62;</pre></div><p class="paragraph"/><a name="Verify User Input"></a><h3>Verify User Input</h3><p class="paragraph"/>Here's an abbreviated controller class that verifies the captcha value when a new user is saved:
<div class="code"><pre><span class="java&#45;keyword">import</span> com.megatome.grails.RecaptchaService
class UserController &#123;
    RecaptchaService recaptchaService<p class="paragraph"/>    def save = &#123;
        def user = <span class="java&#45;keyword">new</span> User(params)
        ...other validation&#8230;
        def recaptchaOK = <span class="java&#45;keyword">true</span>
        <span class="java&#45;keyword">if</span> (!recaptchaService.verifyAnswer(session, request.getRemoteAddr(), params)) &#123;
             recaptchaOK = <span class="java&#45;keyword">false</span>
        &#125;
        <span class="java&#45;keyword">if</span>(!user.hasErrors() &#38;&#38; recaptchaOK &#38;&#38; user.save()) &#123;
            recaptchaService.cleanUp(session)
            ...other account creation acivities&#8230;
            render(view:'showConfirmation',model:&#91;user:user&#93;)
        &#125;
        <span class="java&#45;keyword">else</span> &#123;
            render(view:'create',model:&#91;user:user&#93;)
        &#125;
    &#125;
&#125;</pre></div><p class="paragraph"/><a name="Sample Using a Custom Theme"></a><h3>Sample Using a Custom Theme</h3><p class="paragraph"/><div class="code"><pre>&#60;g:form action=<span class="java&#45;quote">"validateCustom"</span> method=<span class="java&#45;quote">"post"</span> &#62;
    &#60;div id=<span class="java&#45;quote">"recaptcha_widget"</span> style=<span class="java&#45;quote">"display:none"</span>&#62;
        &#60;div id=<span class="java&#45;quote">"recaptcha_image"</span> style=<span class="java&#45;quote">"width:300px;height:57px;"</span>&#62;&#60;/div&#62;
        &#60;div class=<span class="java&#45;quote">"recaptcha_only_if_incorrect_sol"</span> style=<span class="java&#45;quote">"color:red;"</span>&#62;
            Incorrect Answer
        &#60;/div&#62;
        Enter the words above:
        &#60;input id=<span class="java&#45;quote">"recaptcha_response_field"</span> name=<span class="java&#45;quote">"recaptcha_response_field"</span> type=<span class="java&#45;quote">"text"</span> autocomplete=<span class="java&#45;quote">"off"</span>/&#62;
        &#60;div&#62;
            &#60;a href=<span class="java&#45;quote">"javascript:Recaptcha.reload()"</span>&#62;Get another CAPTCHA&#60;/a&#62;
        &#60;/div&#62;
        &#60;div class=<span class="java&#45;quote">"recaptcha_only_if_image"</span>&#62;
            &#60;a href=<span class="java&#45;quote">"javascript:Recaptcha.switch_type('audio')"</span>&#62;Get an audio CAPTCHA&#60;/a&#62;
        &#60;/div&#62;
        &#60;div&#62;
            &#60;a href=<span class="java&#45;quote">"javascript:Recaptcha.showhelp()"</span>&#62;Help&#60;/a&#62;
        &#60;/div&#62;
   &#60;/div&#62;
   &#60;recaptcha:ifEnabled&#62;
       &#60;recaptcha:recaptcha theme=<span class="java&#45;quote">"custom"</span> lang=<span class="java&#45;quote">"en"</span> custom_theme_widget=<span class="java&#45;quote">"recaptcha_widget"</span>/&#62;
   &#60;/recaptcha:ifEnabled&#62;
   &#60;br/&#62;
   &#60;g:submitButton name=<span class="java&#45;quote">"submit"</span>/&#62;
&#60;/g:form&#62;</pre></div><p class="paragraph"/><a name="Testing"></a><h3>Testing</h3><p class="paragraph"/>With version 0.4.5, the plugin should be easier to integrate into test scenarios. You can look at the test cases in the plugin itself, or you can implement something similar to:
<div class="code"><pre><span class="java&#45;keyword">private</span> void buildAndCheckAnswer(def postText, def expectedValid, def expectedErrorMessage) &#123;
    def mocker = <span class="java&#45;keyword">new</span> MockFor(Post.class)
    mocker.demand.getQueryString(4..4) &#123; <span class="java&#45;keyword">new</span> QueryString() &#125;
    mocker.demand.getText &#123; postText &#125;
    mocker.use &#123;
      def response = recaptchaService.checkAnswer(<span class="java&#45;quote">"123.123.123.123"</span>, <span class="java&#45;quote">"abcdefghijklmnop"</span>, <span class="java&#45;quote">"response"</span>)<p class="paragraph"/>      assertTrue response.valid == expectedValid
      assertEquals expectedErrorMessage, response.errorMessage
    &#125;
&#125;</pre></div><p class="paragraph"/>The <code>postText</code> parameter represents the response from the ReCaptcha server. Here are examples of simulating success and failure results:
<div class="code"><pre><span class="java&#45;keyword">public</span> void testCheckAnswerSuccess() &#123;
    // ReCaptcha server will <span class="java&#45;keyword">return</span> <span class="java&#45;keyword">true</span> to indicate success
    buildAndCheckAnswer(<span class="java&#45;quote">"<span class="java&#45;keyword">true</span>"</span>, <span class="java&#45;keyword">true</span>, <span class="java&#45;keyword">null</span>)
&#125;<p class="paragraph"/><span class="java&#45;keyword">public</span> void testCheckAnswerFailure() &#123;
    // ReCaptcha server will <span class="java&#45;keyword">return</span> <span class="java&#45;keyword">false</span>, followed by the error message on a <span class="java&#45;keyword">new</span> line <span class="java&#45;keyword">for</span> failure
    buildAndCheckAnswer("<span class="java&#45;keyword">false</span>&#92;&#92;nError Message<span class="java&#45;quote">", <span class="java&#45;keyword">false</span>, "</span>Error Message")
&#125;</pre></div><p class="paragraph"/><a name="Usage - Mailhide"></a><h1>Usage - Mailhide</h1><p class="paragraph"/><a name="Edit the Configuration"></a><h2>Edit the Configuration</h2><p class="paragraph"/>The plugin creates a file called  <code>RecaptchaConfig.groovy</code>  in  <code>grails-app/conf</code>  that includes the following content:
<div class="code"><pre>&#8230; ReCaptcha configuration...<p class="paragraph"/>mailhide &#123;
    publicKey = <span class="java&#45;quote">""</span>
    privateKey = <span class="java&#45;quote">""</span>
&#125;<p class="paragraph"/>...ReCaptcha configuration...</pre></div>
You must enter your public and private Mailhide keys, or errors will be thrown when trying to display a Mailhide link.<p class="paragraph"/><a name="Use the Tag Library"></a><h2>Use the Tag Library</h2><p class="paragraph"/>The plugin includes two Mailhide tags:  <code>&#60;recaptcha:mailhide&#62;</code> and <code>&#60;recaptcha:mailhideURL&#62;</code> .
<ul class="star">
<li>The  <code>&#60;recaptcha:mailhide&#62;</code>  tag creates a Mailhide URL that opens in a new, pop-up window per the Mailhide specification. It supports one attribute: "emailAddress", to specify the email to be hidden. The link will be created around whatever content is in the body of the tag.</li>
<li>The  <code>&#60;recaptcha:mailhideURL&#62;</code>  tag creates a "raw" URL that can be used however desired. This is useful if the pop-up behavior of the other tag is not wanted. It supports two attributes: "emailAddress" and "var". The "emailAddress" attribute specifies the email to be hidden, while the "var" attribute specifies the name of the variable that the created URL should be available under in the page. The URL variable is only available in the context of the tag body.</li>
</ul><a name="Examples"></a><h2>Examples</h2><p class="paragraph"/><a name="mailhide tag"></a><h3>mailhide tag</h3>
<div class="code"><pre>&#60;recaptcha:mailhide emailAddress=<span class="java&#45;quote">"x@example.com"</span>&#62;Some text to wrap in a link&#60;/recaptcha:mailhide&#62;</pre></div><p class="paragraph"/>will create:<p class="paragraph"/><div class="code"><pre>&#60;a href=<span class="java&#45;quote">"http://www.google.com/recaptcha/mailhide/d?k=...publicKey...&#38;c=..encryptedEmail..."</span>
     onclick=<span class="java&#45;quote">"window.open('http://www.google.com/recaptcha/mailhide/d?k=...publicKey...&#38;c=...encryptedEmail...', '', 
     'toolbar=0,scrollbars=0,location=0,statusbar=0,menubar=0,resizable=0,width=500,height=300'); <span class="java&#45;keyword">return</span> <span class="java&#45;keyword">false</span>;"</span> 
     title=<span class="java&#45;quote">"Reveal <span class="java&#45;keyword">this</span> e&#45;mail address"</span>&#62;Some text to wrap in a link&#60;/a&#62;</pre></div><p class="paragraph"/><a name="mailhideURL tag"></a><h3>mailhideURL tag</h3>
<div class="code"><pre>&#60;recaptcha:mailhideURL emailAddress=<span class="java&#45;quote">"x@example.com"</span> <span class="java&#45;keyword">var</span>=<span class="java&#45;quote">"mu"</span>&#62;
Created Mailhide URL: $&#123;mu&#125;
&#60;/recaptcha:mailhideURL&#62;</pre></div><p class="paragraph"/>will create:<p class="paragraph"/><div class="code"><pre>Created Mailhide URL: http://www.google.com/recaptcha/mailhide/d?k=...publicKey...&#38;c=...encryptedEmail...</pre></div><p class="paragraph"/><a name="Misc."></a><h1>Misc.</h1><p class="paragraph"/>
<a name="CHANGELOG"></a><h3>CHANGELOG</h3>
<ul class="star">
<li>0.5.0 Add Mailhide support. Add support for specifying configuration options elsewhere than <code>RecaptchaConfig.groovy</code> via the <code>grails.config.locations</code> method.</li>
<li>0.4.5 Add code to perform the ReCaptcha functionality - removed recaptcha4j library. Don't add captcha instance to session to avoid serialization issues. Hopefully make it easier to test against.</li>
<li>0.4 New version number for Grails 1.1. Same functionality as 0.3.2</li>
<li>0.3.2 Moved code into packages. Tried to make licensing easier to discern. Updated to Grails 1.0.4</li>
<li>0.3 Added support for environments and new  <code>&#60;recaptcha:ifFailed&#62;</code>  tag. Updated to Grails 1.0.3</li>
<li>0.2 initial release, developed and tested against Grails 1.0.2</li>
</ul><a name="KNOWN ISSUES"></a><h3>KNOWN ISSUES</h3>
<ul class="star">
<li>If you are testing locally on a Mac, you may need to change  <code>recaptchaService.verifyAnswer(session, request.getRemoteAddr(), params)</code>  to  <code>recaptchaService.verifyAnswer(session, "127.0.0.1", params)</code> . This seems to be an issue with the ReCaptcha service not being able to handle the IPV6 localhost identifier.</li>
</ul><a name="TODO"></a><h3>TODO</h3>
<ul class="star">
<li>Automate session cleanup</li>
</ul><a name="Suggestions or Comments"></a><h1>Suggestions or Comments</h1><p class="paragraph"/>Feel free to submit questions or comments to the Grails users mailing list.<p class="paragraph"/><a href="http://grails.org/Mailing lists" class="pageLink">http://grails.org/Mailing+lists</a><p class="paragraph"/>Alternatively you can contact me directly - cjohnston at megatome dot com

</div>
